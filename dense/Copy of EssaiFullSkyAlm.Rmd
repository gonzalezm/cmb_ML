---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.1'
      jupytext_version: 1.2.1
  kernelspec:
    display_name: Python 2
    language: python
    name: python2
---

```{python id=8FvWTuITh0RN, colab_type=code, outputId=ed134b0e-0806-445e-b2df-6e6c4b23ec40, executionInfo={'status': 'ok', 'timestamp': 1562252185355, 'user_tz': -120, 'elapsed': 8818, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}, colab={'base_uri': 'https://localhost:8080/', 'height': 486}}
# !pip install camb
# !pip install healpy
```

```{python id=IoFancfhh9HJ, colab_type=code, outputId=87a897cb-7098-4bae-fe75-89d9ff7668fe, executionInfo={'status': 'ok', 'timestamp': 1562252194255, 'user_tz': -120, 'elapsed': 17689, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}, colab={'base_uri': 'https://localhost:8080/', 'height': 408}}
import camb
from camb import model, initialpower
import healpy as hp 
import numpy as np
from pylab import *
rcParams['image.cmap'] = 'jet'

#Set up a new set of parameters for CAMB
pars = camb.CAMBparams()
#This function sets up CosmoMC-like settings, with one massive neutrino and helium set using BBN consistency
pars.set_cosmology(H0=67.5, ombh2=0.022, omch2=0.122, mnu=0.06, omk=0, tau=0.06)
pars.InitPower.set_params(ns=0.965, r=0)
pars.set_for_lmax(2500, lens_potential_accuracy=0);
#calculate results for these parameters
results = camb.get_results(pars)
#get dictionary of CAMB power spectra
powers =results.get_cmb_power_spectra(pars, CMB_unit='muK')
for name in powers: print(name)


#plot the total lensed CMB power spectra versus unlensed, and fractional difference
totCL=powers['total']
unlensedCL=powers['unlensed_scalar']
print(totCL.shape)

# ls = np.arange(totCL.shape[0])
clf()
plot(ls,totCL[:,0], color='k')

```

```{python id=AvuzEOPKLh1Z, colab_type=code, outputId=ad927cbd-62a7-4c8a-d92c-b521f1335451, executionInfo={'status': 'ok', 'timestamp': 1562252201839, 'user_tz': -120, 'elapsed': 25243, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}, colab={'base_uri': 'https://localhost:8080/', 'height': 34}}
# %timeit pars.set_for_lmax(256, lens_potential_accuracy=0); results = camb.get_results(pars)
```

```{python id=7TvrWXl6h_ZB, colab_type=code, outputId=6d5b6de0-26f6-4761-ca86-a563d35497b2, executionInfo={'status': 'ok', 'timestamp': 1562252202837, 'user_tz': -120, 'elapsed': 26220, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}, colab={'base_uri': 'https://localhost:8080/', 'height': 544}}
print(ls[0])
CL = totCL[:,0]/ls/(ls+1)
CL[0]=0

ns = 16
map =hp.synfast(CL[0:5*ns], ns, pixwin=False)
hp.mollview(map)
```

```{python id=c2oEt6aQiCAH, colab_type=code, outputId=109b3b18-a84e-475d-e880-20778610c1ec, executionInfo={'status': 'ok', 'timestamp': 1562252203065, 'user_tz': -120, 'elapsed': 26423, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}, colab={'base_uri': 'https://localhost:8080/', 'height': 773}}
lmax = 2*ns-1
nl = 2*ns
nalm = (2*ns)*(2*ns+1)/2
outcl, outalm = hp.anafast(map,alm=True, lmax=lmax)
print(outcl.shape, nl)
print(outalm.shape, nalm)
print(outalm.dtype)
print(outalm[0:50])
ll = np.arange(outcl.shape[0])
clf()
plot(ll,ll*(ll+1)*outcl)
plot(ls, ls*(ls+1)*CL, 'r')
xlim(0,max(ll))
```

```{python id=LqYJB5whiEZ4, colab_type=code, outputId=b4c7d413-6bfc-4ed9-e440-fec67a6041ff, executionInfo={'status': 'ok', 'timestamp': 1562252398491, 'user_tz': -120, 'elapsed': 221820, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}, colab={'base_uri': 'https://localhost:8080/', 'height': 555}}
### Target power spectra
clt = CL[0:nl]
lt = ll[0:nl]

nbmodels = 100000
nnn = int(nbmodels/30)
npixok = 12*ns**2
limit_shape = 3*ns
okpix = np.arange(npixok)
mymaps = np.zeros((nbmodels, npixok))
myalms = np.zeros((nbmodels, nalm), dtype=complex128)
expcls = np.zeros((nbmodels, nl))
mycls = np.zeros((nbmodels, nl))
expcls = np.zeros((nbmodels, nl))
allshapes = np.zeros((nbmodels, len(ls)))
for i in range(nbmodels):
  ylo = np.random.rand()*2
  yhi = np.random.rand()*2
  if (i/nnn)*nnn == i: 
    print(i,ylo,yhi)
  theshape = ylo+(yhi-ylo)/(limit_shape)*ls
  theshape[theshape < 0] = 0
  theshape[limit_shape:] = 0
  allshapes[i,:] = theshape
  theCL = CL*theshape
  themap = hp.synfast(theCL, ns, pixwin=False, verbose=False)
  mymaps[i,:] = themap[okpix]
  expcls[i,:], myalms[i,:] = hp.anafast(themap, lmax=lmax, alm=True)
  mycls[i,:] = theCL[0:nl]

```

```{python id=VpkNeQb6iHbX, colab_type=code, outputId=7f73bd0c-cfb3-42c4-f08e-b3c53adf9c5e, executionInfo={'status': 'ok', 'timestamp': 1562252398499, 'user_tz': -120, 'elapsed': 221809, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}, colab={'base_uri': 'https://localhost:8080/', 'height': 521}}
for i in xrange(nbmodels):
  if (i/nnn)*nnn == i:
    plot(lt, lt*(lt+1)*mycls[i,:])
    
figure()
xlim(0,3*ns+10)
for i in xrange(nbmodels):
  if (i/nnn)*nnn == i:
    plot(ls, allshapes[i,:])
    


```

```{python id=x-eygzYHiMb_, colab_type=code, outputId=41935bc6-0cfb-4cac-cf29-26fde7e66742, executionInfo={'status': 'ok', 'timestamp': 1562252398507, 'user_tz': -120, 'elapsed': 221790, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}, colab={'base_uri': 'https://localhost:8080/', 'height': 286}}
num = np.random.randint(0,nbmodels)
#figure()
#hp.mollview(mymaps[num,:])

figure()
plot(lt, lt*(lt+1)*mycls[num,:])
plot(lt, lt*(lt+1)*expcls[num,:])
```

```{python id=crgTOGoeiO3n, colab_type=code, outputId=d3a7ca1b-5328-4052-c9c8-d6002da1e884, executionInfo={'status': 'ok', 'timestamp': 1562252842029, 'user_tz': -120, 'elapsed': 665290, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}, colab={'base_uri': 'https://localhost:8080/', 'height': 419}}
### Deep Networks Configuration for the case of alm -> spectra
from tensorflow import keras
from keras.models import Sequential
model = Sequential()

from keras.layers import Dense
model.add(Dense(units=nalm*6, activation='relu', input_dim=nalm, kernel_initializer='uniform'))
#model.add(Dense(units=nalm/2, activation='linear'))
model.add(Dense(units=nl, activation='linear'))

model.compile(optimizer='adam',
              loss='mse',
              metrics=['accuracy'])

# Training
fraction = 0.8
ilim = int(nbmodels*fraction)
print(ilim)

mx = np.max(np.abs(myalms))
my = np.max(mycls)

from __future__ import print_function
class PrintNum(keras.callbacks.Callback):
  def on_epoch_end(self,epoch,logs):
    if epoch % 10 == 0: 
      print('')
      print(epoch, end='')
    sys.stdout.write('.')
    sys.stdout.flush()

early_stop = keras.callbacks.EarlyStopping(monitor='val_loss', patience=20)


history=model.fit(myalms[0:ilim,:]/mx, mycls[0:ilim]/my, epochs=200, batch_size=1000, validation_split=0.1, verbose=0, callbacks=[early_stop, PrintNum()])
```

```{python id=mY_SROHhnquB, colab_type=code, colab={'base_uri': 'https://localhost:8080/', 'height': 312}, outputId=434ce15a-2e3c-4529-84c0-cbdb2af672f4, executionInfo={'status': 'ok', 'timestamp': 1562252842668, 'user_tz': -120, 'elapsed': 665900, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}}
# summarize history for loss
plot(history.history['loss'])
plot(history.history['val_loss'])
title('model loss')
ylabel('loss')
xlabel('epoch')
legend(['train', 'test'], loc='upper left')
yscale('log')
show()
print(min(history.history['loss']), min(history.history['val_loss']), len(history.history['val_loss']))
```

```{python id=iDECsUpViXJ8, colab_type=code, colab={}}
myalms_test = myalms[ilim:,:]
mycls_test = mycls[ilim:,:]
expcls_test = expcls[ilim:,:]

result = my * model.predict(myalms_test / mx, batch_size=128)
```

```{python id=z3uvqa_nBiXU, colab_type=code, colab={'base_uri': 'https://localhost:8080/', 'height': 298}, outputId=41aeddcf-89f9-4bbb-da14-c7e66b9ed3e8, executionInfo={'status': 'ok', 'timestamp': 1562252844776, 'user_tz': -120, 'elapsed': 667948, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}}
num=np.random.randint(result.shape[0])
plot(lt, lt*(lt+1)*mycls_test[num,:],label ='Input spectra')
plot(lt, lt*(lt+1)*expcls_test[num,:],label ='Anafast')
plot(lt, lt*(lt+1)*result[num,:],label ='ML')
title(num)
legend()
```

```{python id=q-WS5WPEOZ9b, colab_type=code, colab={'base_uri': 'https://localhost:8080/', 'height': 538}, outputId=c4a78607-1676-4717-8eaa-5d2a9a47e476, executionInfo={'status': 'ok', 'timestamp': 1562252846777, 'user_tz': -120, 'elapsed': 669927, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}}
figure()
a=hist(np.ravel(expcls_test[:,2:]-mycls_test[:,2:]), bins=100, range=[-5,5], alpha=0.5, label='Anafast')
a=hist(np.ravel(result[:,2:]-mycls_test[:,2:]), bins=100, range=[-5,5], alpha=0.5, label = 'ML')
yscale('log')
legend()

ch2anafast = np.sum((expcls_test[:,2:]-mycls_test[:,2:])**2, axis=1)
ch2ML = np.sum((result[:,2:]-mycls_test[:,2:])**2, axis=1)

figure()
a=hist(ch2anafast, bins=100, range=[0,10000], alpha=0.5, label='Anafast')
a=hist(ch2ML, bins=100, range=[0,10000], alpha=0.5, label = 'ML')
yscale('log')
legend()
```

```{python id=TA_pyutYBE7p, colab_type=code, colab={}}
# summarize history for loss
plot(historyT.history['loss'])
plot(historyT.history['val_loss'])
title('model loss')
ylabel('loss')
xlabel('epoch')
legend(['train', 'test'], loc='upper left')
yscale('log')
show()
print(min(historyT.history['loss']), min(historyT.history['val_loss']), len(historyT.history['val_loss']))
```

```{python id=4zdk1bHXtgmH, colab_type=code, colab={}}
from joblib import dump
import datetime
from google.colab import drive
drive.mount('/content/gdrive')

today = datetime.datetime.now().strftime('%Y%m%d_%H_%M_%S')
out_dir="/content/gdrive/My Drive/Colab Notebooks/"

np.save(out_dir + today + "_mymaps", mymaps)
np.save(out_dir + today + "_myalms", myalms)
np.save(out_dir + today + "_mycls", mycls)
np.save(out_dir + today + "_expcls", expcls)
dump(model, out_dir +  today + "_mymodel_dense_alm.joblib")
```

```{python id=3oE5MBRjc9Ud, colab_type=code, colab={}}
np.save(out_dir + today + "_loss-alm", history.history['loss'])
np.save(out_dir + today + "_val_loss-alm", history.history['val_loss'])
```

```{python id=radLUEXUc97C, colab_type=code, colab={}}

```
