---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.1'
      jupytext_version: 1.2.3
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python id=zjoK5xlQZvTS, colab_type=code, outputId=219d3218-cd97-480a-a331-2d0144464ae7, executionInfo={'status': 'ok', 'timestamp': 1563882517353, 'user_tz': -120, 'elapsed': 66117, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}, colab={'base_uri': 'https://localhost:8080/', 'height': 781}}
# !pip install git+https://github.com/gonzalezm/NNhealpix.git
```

```{python id=VKEqM621Zyf9, colab_type=code, outputId=cc13aa0c-f73f-4716-abe8-339acc964c45, executionInfo={'status': 'ok', 'timestamp': 1563882523601, 'user_tz': -120, 'elapsed': 72287, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}, colab={'base_uri': 'https://localhost:8080/', 'height': 312}}
# !pip install camb
# !pip install healpy
```

```{python id=HxgWd-uGZ4s2, colab_type=code, outputId=b216b786-5ac6-4d3b-8f0a-4650919fd66d, executionInfo={'status': 'ok', 'timestamp': 1563882528984, 'user_tz': -120, 'elapsed': 77619, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}, colab={'base_uri': 'https://localhost:8080/', 'height': 436}}
import keras as kr
import datetime
import nnhealpix.layers
from google.colab import drive
drive.mount('/content/gdrive')

today = datetime.datetime.now().strftime('%Y%m%d_%H_%M_%S')
in_dir="/content/gdrive/My Drive/Colab Notebooks/test17"

model = kr.models.load_model(in_dir +  "_mymodel_CNN.h5py.File", 
                   custom_objects={'OrderMap': nnhealpix.layers.OrderMap})
```

```{python id=SZKYs-sSZ49Q, colab_type=code, outputId=e4f54946-23a6-4acb-ddf8-64efa411f79b, executionInfo={'status': 'ok', 'timestamp': 1563882536911, 'user_tz': -120, 'elapsed': 85443, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}, colab={'base_uri': 'https://localhost:8080/', 'height': 139}}
import camb
from camb import initialpower
import healpy as hp 
import numpy as np
from pylab import *
rcParams['image.cmap'] = 'jet'

#Set up a new set of parameters for CAMB
pars = camb.CAMBparams()
#This function sets up CosmoMC-like settings, with one massive neutrino and helium set using BBN consistency
pars.set_cosmology(H0=67.5, ombh2=0.022, omch2=0.122, mnu=0.06, omk=0, tau=0.06)
pars.InitPower.set_params(ns=0.965, r=0)
pars.set_for_lmax(2500, lens_potential_accuracy=0)
#calculate results for these parameters
results = camb.get_results(pars)
#get dictionary of CAMB power spectra
powers =results.get_cmb_power_spectra(pars, CMB_unit='muK')
for name in powers: print(name)


#plot the total lensed CMB power spectra versus unlensed, and fractional difference
totCL=powers['total']
unlensedCL=powers['unlensed_scalar']
print(totCL.shape)

# ls = np.arange(totCL.shape[0])
```

```{python id=x6AI6ISbaS-l, colab_type=code, outputId=417afb0d-5888-4de3-c425-a18a169637f5, executionInfo={'status': 'ok', 'timestamp': 1563882536930, 'user_tz': -120, 'elapsed': 85404, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}, colab={'base_uri': 'https://localhost:8080/', 'height': 69}}
print(ls[0])
CL = totCL[:,0]/ls/(ls+1)
CL[0]=0

ns = 16
lmax = 2*ns-1
nl = 2*ns
nalm = (nl)*(nl+1)/2
```

```{python id=JbFcJPtHaXXW, colab_type=code, colab={}}
### Target power spectra

nbmodels = 110000
nnn = int(nbmodels/30)
npixok = 12*ns**2
limit_shape = 3*ns
okpix = np.arange(npixok)
mymaps = np.zeros((nbmodels, npixok))
myalms = np.zeros((nbmodels, int(nalm)), dtype=complex128)
expcls = np.zeros((nbmodels, nl))
mycls = np.zeros((nbmodels, nl))
allshapes = np.zeros((nbmodels, len(ls)))
for i in range(nbmodels):
  ylo = np.random.rand()*2
  yhi = np.random.rand()*2
  theshape = ylo+(yhi-ylo)/(limit_shape)*ls
  theshape[theshape < 0] = 0
  theshape[limit_shape:] = 0
  allshapes[i,:] = theshape
  theCL = CL*theshape
  themap = hp.synfast(theCL, ns, pixwin=False, verbose=False)
  mymaps[i,:] = themap[okpix]
  expcls[i,:], myalms[i,:] = hp.anafast(themap, lmax=lmax, alm=True)
  mycls[i,:] = theCL[0:nl]
```

```{python id=Bn5iIOTfaaaU, colab_type=code, colab={'base_uri': 'https://localhost:8080/', 'height': 52}, outputId=e29b15ed-cf33-43c9-a8fe-7a1106d2f1a1, executionInfo={'status': 'ok', 'timestamp': 1563894651955, 'user_tz': -120, 'elapsed': 5908153, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}}
# Training
nbtest = 10000

mapx = (mymaps-np.mean(mymaps))/np.std(mymaps)
clstd = np.std(mycls)
clmean = np.mean(mycls)
cly = (mycls-np.mean(mycls))/np.std(mycls)

mapx = mapx.reshape(mapx.shape[0], len(mapx[0]), 1)

mymaps = mymaps.reshape(mymaps.shape[0], len(mymaps[0]), 1)

class PrintNum(kr.callbacks.Callback):
  def on_epoch_end(self,epoch,logs):
    if (epoch) % 10 == 0: 
      print(epoch+1)
    sys.stdout.write('.')
    sys.stdout.flush()

stop = kr.callbacks.EarlyStopping(monitor='val_loss',
                                  verbose = 0,
                                  restore_best_weights=True,
                                  patience=20)

callbacks = [PrintNum(), stop]

history = model.fit(mapx[:(nbmodels-nbtest),:,:], mycls[:(nbmodels-nbtest),:], epochs=10, batch_size=32, validation_split = 0.1, verbose = 0, callbacks=callbacks, shuffle = True)
```

```{python id=kdRjeAJOapWK, colab_type=code, colab={'base_uri': 'https://localhost:8080/', 'height': 312}, outputId=6fb3a50e-c1b8-4648-bcc6-6c2bcb2f37b6, executionInfo={'status': 'ok', 'timestamp': 1563894652754, 'user_tz': -120, 'elapsed': 814, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}}
loss1 = np.load(in_dir + '_hist_loss.npy')
val_loss1 = np.load(in_dir + '_hist_val_loss.npy')

loss2 = history.history['loss']
val_loss2 = history.history['val_loss']

loss = np.concatenate((loss1,loss2))
val_loss = np.concatenate((val_loss1,val_loss2))

plot(loss)
plot(val_loss)
title('model loss')
ylabel('loss')
xlabel('epoch')
legend(['train', 'test'], loc='upper left')
yscale('log')
show()
print(min(loss), min(val_loss), len(val_loss))
```

```{python id=bxMs1kkdauwk, colab_type=code, colab={}}
mymaps_test = mapx[(nbmodels-nbtest):,:,:]
mycls_test = mycls[(nbmodels-nbtest):,:]
expcls_test = expcls[(nbmodels-nbtest):,:]

result = model.predict(mymaps_test, batch_size=128)

```

```{python id=E9gatY-JbCC9, colab_type=code, colab={'base_uri': 'https://localhost:8080/', 'height': 52}, outputId=78f74ca0-d5cd-4b95-fe24-c1e4f29409d9, executionInfo={'status': 'ok', 'timestamp': 1563894680754, 'user_tz': -120, 'elapsed': 134, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}}
mean_err = np.mean(abs((result[:,2:]-mycls_test[:,2:])/mycls_test[:,2:]*100))
mean_err_ana = np.mean(abs((expcls_test[:,2:]-mycls_test[:,2:])/mycls_test[:,2:]*100))
print(mean_err)
print(mean_err_ana)
```

```{python id=WCBxxR_bbda9, colab_type=code, colab={'base_uri': 'https://localhost:8080/', 'height': 298}, outputId=578d86a9-f2b6-46ca-ad1b-bd71d2d924a2, executionInfo={'status': 'ok', 'timestamp': 1563894681260, 'user_tz': -120, 'elapsed': 541, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}}
lt=np.arange(nl)
num=np.random.randint(result.shape[0])
plot(lt, lt*(lt+1)*mycls_test[num,:],label ='Input spectra')
plot(lt, lt*(lt+1)*expcls_test[num,:],label ='Anafast')
plot(lt, lt*(lt+1)*result[num,:],label ='ML')
title(num)
legend()
```

```{python id=DwKduDPAbiqU, colab_type=code, colab={'base_uri': 'https://localhost:8080/', 'height': 542}, outputId=71b82efc-2abd-4904-a5ec-88a8a787a83f, executionInfo={'status': 'ok', 'timestamp': 1563894807699, 'user_tz': -120, 'elapsed': 3288, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}}
figure()
a=hist(np.ravel(expcls_test[:,2:]-mycls_test[:,2:]), bins=100, alpha=0.5, label='Anafast')
a=hist(np.ravel(result[:,2:]-mycls_test[:,2:]), bins=100, alpha=0.5, label = 'ML')
yscale('log')
legend()

ch2anafast = np.sum((expcls_test[:,2:]-mycls_test[:,2:])**2, axis=1)
ch2ML = np.sum((result[:,2:]-mycls_test[:,2:])**2, axis=1)

figure()
a=hist(ch2anafast, bins=100, alpha=0.5, label='Anafast')
a=hist(ch2ML, bins=100, alpha=0.5, label = 'ML')
yscale('log')
legend()
```

```{python id=y-cGStBAbjW8, colab_type=code, colab={'base_uri': 'https://localhost:8080/', 'height': 34}, outputId=a18e9a61-5c27-4be9-936c-55dd60928b23, executionInfo={'status': 'ok', 'timestamp': 1563894683887, 'user_tz': -120, 'elapsed': 305, 'user': {'displayName': 'X.D.topher sama', 'photoUrl': 'https://lh5.googleusercontent.com/-bezrQ2Sgsnc/AAAAAAAAAAI/AAAAAAAACa4/mLbI1TQOnSM/s64/photo.jpg', 'userId': '09059908567566041974'}}}
import keras as kr
import datetime
from google.colab import drive
drive.mount('/content/gdrive')

today = datetime.datetime.now().strftime('%Y%m%d_%H_%M_%S')
out_dir="/content/gdrive/My Drive/Colab Notebooks/"

kr.models.save_model(model, out_dir +  "test18" + "_mymodel_CNN.h5py.File")
np.save(out_dir + "test18" + '_hist_loss', loss)
np.save(out_dir + "test18" + '_hist_val_loss', val_loss)
```

```{python id=WPaFvLACmJ2c, colab_type=code, colab={}}

```
